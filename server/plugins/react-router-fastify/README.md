# React Router Fastify Plugin

A Fastify plugin that integrates React Router with Fastify, providing seamless server-side rendering and request handling for React Router applications.

## Overview

The `react-router-fastify` plugin is a bridge between React Router and Fastify that enables server-side rendering (SSR) and proper request handling for React Router applications. It converts Fastify requests to React Router requests, handles the routing logic, and sends responses back through Fastify.

## Installation

This plugin is part of the `lazy_days_playground` project and is located at `server/plugins/react-router-fastify/`. It depends on:

- `react-router` (^7.10.1): React Router framework
- `@react-router/node` (^7.10.1): Node.js utilities for React Router
- `fastify` (^5.6.2): Web framework

## Quick Start

```typescript
import { createRequestHandler } from "@server/plugins/react-router-fastify";
import { createServerBuild } from "./path/to/build";

// Create the build (in development, this might be a function)
const build = createServerBuild();

// Create the request handler plugin
const reactRouterPlugin = createRequestHandler({
  build,
  mode: "development", // or "production"
});

// Register the plugin with Fastify
await fastify.register(reactRouterPlugin);
```

## API Reference

### `createRequestHandler(options: CreateRequestHandlerOptions): FastifyPluginCallback`

Factory function that creates a Fastify plugin for handling React Router requests.

**Parameters:**

- `options: CreateRequestHandlerOptions` - Configuration object for the request handler

**Returns:**

- `FastifyPluginCallback` - A Fastify plugin that can be registered with a Fastify instance

### `CreateRequestHandlerOptions`

```typescript
interface CreateRequestHandlerOptions {
  build: ServerBuild | (() => Promise<ServerBuild>);
  getLoadContext?: GetLoadContextFunction;
  mode?: "development" | "production" | "test";
}
```

**Properties:**

- `build: ServerBuild | (() => Promise<ServerBuild>)` - The React Router server build object or a function that returns it
- `getLoadContext?: GetLoadContextFunction` - Optional function to provide load context for route loaders and actions
- `mode?: "development" | "production" | "test"` - The mode in which React Router should operate (defaults to development)

### `GetLoadContextFunction`

```typescript
type GetLoadContextFunction = (
  req: FastifyRequest,
  res: FastifyReply
) => MiddlewareEnabled extends true
  ? MaybePromise<RouterContextProvider>
  : MaybePromise<AppLoadContext>;
```

A function that returns the value to use as `context` in route `loader` and `action` functions. This serves as an escape hatch to pass environment/platform-specific values through to your loader/action functions, such as values generated by Fastify middleware like `req.session`.

## Request Handling

The plugin handles all HTTP methods (`GET`, `POST`, `PUT`, `DELETE`, etc.) for all routes (`*`) and processes them through React Router's request handling pipeline:

1. **Request Conversion**: Converts Fastify requests to standard Web API `Request` objects
2. **Header Processing**: Properly handles headers, including multi-value headers and proxy headers
3. **Load Context**: Provides optional load context to route loaders and actions
4. **Response Handling**: Converts React Router responses back to Fastify responses
5. **Streaming Support**: Handles streaming responses for features like Server-Sent Events

## Key Features

### Header Processing

The plugin properly handles various header scenarios:

- **Multi-value headers**: Arrays of header values are converted to multiple header entries
- **Proxy headers**: Respects `X-Forwarded-Host` and `Host` headers for proper URL construction
- **Trust proxy**: Uses Fastify's trust proxy settings for hostname resolution

### Request Body Handling

- **Non-GET/HEAD requests**: Request bodies are properly streamed as readable streams
- **Duplex streams**: Uses half-duplex streaming for request bodies
- **Abort signals**: Provides abort controllers that are properly cleaned up

### Response Handling

- **Status codes**: Properly sets HTTP status codes and status messages
- **Response headers**: Transfers all headers from React Router responses
- **Streaming responses**: Supports streaming responses including Server-Sent Events
- **Empty responses**: Handles responses without bodies

## Type Definitions

### Request Types

The plugin uses standard Fastify request and reply types:

```typescript
import type { FastifyRequest, FastifyReply } from "fastify";
```

### Response Types

The plugin works with standard Web API `Response` objects from React Router.

## Usage Examples

### Basic Setup

```typescript
import { createRequestHandler } from "@server/plugins/react-router-fastify";
import { createServerBuild } from "./build";

// In development
const build = createServerBuild();

// Create and register the plugin
const reactRouterPlugin = createRequestHandler({
  build,
  mode: "development",
});

await fastify.register(reactRouterPlugin);
```

### Production Setup

```typescript
import { createRequestHandler } from "@server/plugins/react-router-fastify";
import build from "./build/index.js"; // Pre-built server build

const reactRouterPlugin = createRequestHandler({
  build,
  mode: "production",
});

await fastify.register(reactRouterPlugin);
```

### With Load Context

```typescript
import { createRequestHandler } from "@server/plugins/react-router-fastify";
import type { GetLoadContextFunction } from "@server/plugins/react-router-fastify";

const getLoadContext: GetLoadContextFunction = (req, res) => {
  return {
    // Pass Fastify-specific context to your routes
    session: req.session,
    user: req.user,
    // Add any other context your routes need
    env: process.env,
  };
};

const reactRouterPlugin = createRequestHandler({
  build,
  getLoadContext,
  mode: "production",
});

await fastify.register(reactRouterPlugin);
```

### Advanced Configuration

```typescript
import { createRequestHandler } from "@server/plugins/react-router-fastify";

// Async build loading (useful for development)
const build = () => import("./build/index.js");

const reactRouterPlugin = createRequestHandler({
  build,
  getLoadContext: async (req, res) => {
    // Async load context
    const user = await getUserFromSession(req);
    return {
      user,
      req,
      res,
    };
  },
  mode: process.env.NODE_ENV === "production" ? "production" : "development",
});

await fastify.register(reactRouterPlugin);
```

## Integration with Fastify Middleware

The plugin integrates seamlessly with Fastify middleware. Any middleware registered before the React Router plugin will be executed:

```typescript
import fastifySession from "@fastify/session";
import fastifyCookie from "@fastify/cookie";

// Register middleware before React Router
await fastify.register(fastifyCookie);
await fastify.register(fastifySession, { secret: "your-secret" });

// Then register React Router
await fastify.register(reactRouterPlugin);
```

## Error Handling

The plugin relies on React Router's built-in error handling. React Router will:

- Handle route not found errors (404)
- Handle loader/action errors
- Provide error boundaries for client-side error recovery
- Log errors according to React Router's configuration

Fastify-level errors (connection errors, etc.) should be handled at the Fastify application level.

## Performance Considerations

### Development vs Production

- **Development**: Uses dynamic build loading for hot reloading
- **Production**: Uses pre-built static assets for optimal performance

### Memory Management

- **Request cleanup**: Abort controllers are properly cleaned up
- **Stream handling**: Uses efficient streaming for request/response bodies
- **Header processing**: Minimizes header copying and processing overhead

## Dependencies

- `react-router` (^7.10.1): Core React Router framework
- `@react-router/node` (^7.10.1): Node.js specific utilities for React Router
- `fastify` (^5.6.2): Web framework

## License

This plugin is part of the `lazy_days_playground` project. See the main project license for details.
